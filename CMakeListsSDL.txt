cmake_minimum_required(VERSION 2.6)

set(EXECUTABLE Mandrill)

project(${EXECUTABLE})

# A list of header and source files used by your application.
set(SOURCES ...)
file(GLOB_RECURSE SOURCES "src/*.cpp")

set(HEADERS ...)
file(GLOB_RECURSE HEADERS "src/*.hpp")

# We we build SDL using the Makefile, it recomends creating a build folder
set(SDL_FOLDER ${CMAKE_CURRENT_SOURCE_DIR}/libs/sdl/build/local CACHE STRING "Path to SDL 2.0" FORCE)
set(SDL_INCLUDES "${SDL_FOLDER}/SD2")

# Building for Windows is much easier...
if(WIN32)
set(SDL_FOLDER ${CMAKE_CURRENT_SOURCE_DIR}/libs/sdl CACHE STRING "Path to SDL 2.0" FORCE)
set(SDL_INCLUDES ${SDL_FOLDER})
endif()

find_library(SDL_LIBRARY
    NAMES SDL-2.0.0 SDL2
    PATHS ${SDL_FOLDER}
    PATH_SUFFIXES lib VisualC/SDL/Release
    NO_DEFAULT_PATH
)
find_library(SDLMAIN_LIBRARY
    NAMES SDL2main
    PATHS ${SDL_FOLDER}
    PATH_SUFFIXES lib VisualC/SDLmain/Release
    NO_DEFAULT_PATH
)

# we also need to find the system's OpenGL version
find_package(OpenGL REQUIRED)

# on OS X we also have to add '-framework Cocoa' as library.  This is
# actually a bit of an hack but it's easy enough and reliable.
set(EXTRA_LIBS "")
if (APPLE)
    set(EXTRA_LIBS ${EXTRA_LIBS} "-framework Cocoa")
endif()

# our own include folder and the SDL one are additional folders we
# want to have on our path.
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${SDL_FOLDER}/include
)

# Now we define what makes our executable.  First thing is the name,
# WIN32 is needed to make this a Win32 GUI application, MACOSX_BUNDLE
# activates bundle mode on OS X and the last two things are our source
# and header files this executable consists of.
add_executable(
  ${EXECUTABLE}
    WIN32
    MACOSX_BUNDLE
    ${SOURCES}
    ${HEADERS}
)

# Lastly we have to link the OpenGL libraries, SDL and the cocoa
# framework to our application.  The latter is only happening on
# OS X obviously.
target_link_libraries(
  ${EXECUTABLE}
    ${OPENGL_LIBRARIES}
    ${SDL_LIBRARY}
    ${SDLMAIN_LIBRARY}
    ${EXTRA_LIBS}
)

if(WIN32)
    set(VS_OUTPUT_DIR ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_CFG_INTDIR})
    add_custom_command(TARGET ${EXECUTABLE} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${SDL_FOLDER}/VisualC/SDL/Release/SDL2.dll ${VS_OUTPUT_DIR}/SDL2.dll)
endif()
if(APPLE)
    set(BUNDLE_BINARY
      ${CMAKE_CURRENT_BINARY_DIR}/${EXECUTABLE}.app/Contents/MacOS/${EXECUTABLE})
    add_custom_command(TARGET ${EXECUTABLE} POST_BUILD
        COMMAND "python ${CMAKE_CURRENT_SOURCE_DIR}/scripts/frameworkify.py ${BUNDLE_BINARY} ${SDL_LIBRARY}")
endif()
